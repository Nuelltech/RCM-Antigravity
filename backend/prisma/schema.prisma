generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// CORE: Tenants & Users
// -----------------------------------------------------------------------------

model Tenant {
  id                  Int       @id @default(autoincrement())
  uuid                String    @unique @default(uuid())
  nome_restaurante    String
  slug                String    @unique
  nif                 String?   @unique
  morada              String?
  telefone            String?
  email_contacto      String?
  logo_url            String?
  plano               String    @default("trial") // trial, basico, profissional, enterprise
  data_expiracao_plano DateTime?
  ativo               Boolean   @default(true)
  configuracoes       Json?     // targets margem, moeda, timezone
  metadata            Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  users               User[]
  sessions            Session[]
  tenantLimits        TenantLimits?
  auditLogs           AuditLog[]
  familias            Familia[]
  subfamilias         Subfamilia[]
  produtos            Produto[]
  variacoesProduto    VariacaoProduto[]
  historicoPrecos     HistoricoPreco[]
  compras             Compra[]
  comprasTemporarias  CompraTemporaria[]
  receitas            Receita[]
  ingredientesReceita IngredienteReceita[]
  etapasReceita       EtapaReceita[]
  menuItems           MenuItem[]
  vendas              Venda[]
  stockTeorico        StockTeorico[]
  alertasAi           AlertaAi[]
  conversasAi         ConversaAi[]
  integracoes         Integracao[]
  mapeamentosPos      MapeamentoPos[]
  combos              Combo[]
  comboItens          ComboItem[]
  comboCategorias     ComboCategoria[]
  comboOpcoes         ComboCategoriaOpcao[]
  formatosVenda       FormatoVenda[]
  templateFormatosVenda TemplateFormatoVenda[]
  templateVariacoesCompra TemplateVariacaoCompra[]
  dadosRestaurante    DadosRestaurante?
  custosEstrutura     CustoEstrutura[]
  localizacoes        Localizacao[]
  listasCalculadora   ListaCalculadora[]
  sessoesInventario   SessaoInventario[]
  itensInventario     ItemInventario[]

  @@map("tenants")
}

model User {
  id                  Int       @id @default(autoincrement())
  tenant_id           Int
  uuid                String    @unique @default(uuid())
  nome                String
  email               String
  password_hash       String
  role                String    @default("operacional") // owner, admin, gestor, operacional, apenas_leitura
  two_factor_secret   String?
  two_factor_enabled  Boolean   @default(false)
  email_verificado    Boolean   @default(false)
  verification_code   String?
  verification_code_expires_at DateTime?
  ultimo_login        DateTime?
  ativo               Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tenant              Tenant    @relation(fields: [tenant_id], references: [id])
  sessions            Session[]
  twoFactorBackupCodes TwoFactorBackupCode[]
  auditLogs           AuditLog[]
  comprasValidadas    Compra[]
  comprasTempCriadas  CompraTemporaria[]
  receitasCriadas     Receita[]
  vendasRegistadas    Venda[]
  conversasAi         ConversaAi[]
  integracoesCriadas  Integracao[]
  historicoPrecos     HistoricoPreco[]
  listasCalculadora   ListaCalculadora[]
  sessoesCriadas      SessaoInventario[] @relation("SessaoCriador")
  sessoesFechadas     SessaoInventario[] @relation("SessaoFechador")
  itensContados       ItemInventario[]

  @@unique([tenant_id, email])
  @@map("users")
}

model Session {
  id                  Int       @id @default(autoincrement())
  user_id             Int
  tenant_id           Int
  access_token_hash   String    @db.VarChar(64)
  refresh_token_hash  String    @db.VarChar(64)
  ip_address          String?
  user_agent          String?
  expires_at          DateTime
  refresh_expires_at  DateTime
  revoked             Boolean   @default(false)
  createdAt           DateTime  @default(now())

  user                User      @relation(fields: [user_id], references: [id])
  tenant              Tenant    @relation(fields: [tenant_id], references: [id])

  @@map("sessions")
}

model TwoFactorBackupCode {
  id        Int      @id @default(autoincrement())
  user_id   Int
  code_hash String
  usado     Boolean  @default(false)
  data_uso  DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [user_id], references: [id])

  @@map("two_factor_backup_codes")
}

model TenantLimits {
  tenant_id               Int @id
  max_users               Int @default(5)
  max_produtos            Int @default(100)
  max_receitas            Int @default(50)
  max_storage_mb          Int @default(500)
  storage_usado_mb        Int @default(0)
  api_calls_per_day       Int @default(1000)
  ai_queries_per_month    Int @default(100)
  ai_queries_usado_mes_atual Int @default(0)

  tenant                  Tenant @relation(fields: [tenant_id], references: [id])

  @@map("tenant_limits")
}

model AuditLog {
  id              BigInt   @id @default(autoincrement())
  tenant_id       Int
  user_id         Int?
  acao            String
  entidade_tipo   String?
  entidade_id     String?
  dados_anteriores Json?
  dados_novos     Json?
  ip_address      String?
  user_agent      String?
  resultado       String   // sucesso, erro, negado
  timestamp       DateTime @default(now())

  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  user            User?    @relation(fields: [user_id], references: [id])

  @@index([tenant_id, timestamp])
  @@map("audit_log")
}

// -----------------------------------------------------------------------------
// PRODUTOS & INVENTÁRIO
// -----------------------------------------------------------------------------

model Familia {
  id          Int      @id @default(autoincrement())
  tenant_id   Int
  uuid        String   @default(uuid())
  nome        String
  codigo      String?  // ex: CAR, PEI
  descricao   String?
  icone       String?
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenant_id], references: [id])
  subfamilias Subfamilia[]

  @@unique([tenant_id, nome])
  @@map("familias")
}

model Subfamilia {
  id          Int      @id @default(autoincrement())
  tenant_id   Int
  familia_id  Int
  nome        String
  codigo      String?  // ex: POR, VIT
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenant_id], references: [id])
  familia     Familia  @relation(fields: [familia_id], references: [id])
  produtos    Produto[]

  @@unique([tenant_id, familia_id, nome])
  @@map("subfamilias")
}

model Produto {
  id              Int      @id @default(autoincrement())
  tenant_id       Int
  uuid            String   @default(uuid())
  nome            String
  familia_id      Int?     // Optional mainly for flexibility, but usually required
  subfamilia_id   Int
  unidade_medida  String   // KG, L, Unidade
  descricao       String?  @db.Text
  imagem_url      String?
  codigo_interno  String?
  vendavel        Boolean  @default(false) // NEW: Can be sold directly (not just ingredient)
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  subfamilia      Subfamilia @relation(fields: [subfamilia_id], references: [id])
  variacoes       VariacaoProduto[]
  ingredientesReceita IngredienteReceita[]
  stockTeorico    StockTeorico[]
  comboItens      ComboItem[]
  formatosVenda   FormatoVenda[] // NEW: Sell formats for this product
  itensInventario ItemInventario[]

  @@unique([tenant_id, subfamilia_id, nome])
  @@map("produtos")
}

model VariacaoProduto {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  produto_id          Int
  tipo_unidade_compra String   // ex: "Caixa 12un"
  unidades_por_compra Decimal  @db.Decimal(10, 4)
  preco_compra        Decimal  @db.Decimal(10, 2)
  preco_unitario      Decimal  @db.Decimal(10, 4) // Computed in app, stored for cache
  fornecedor          String?
  codigo_fornecedor   String?
  data_ultima_compra  DateTime?
  template_id         Int?     // Reference to template used
  ativo               Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  produto             Produto  @relation(fields: [produto_id], references: [id])
  template            TemplateVariacaoCompra? @relation("TemplateUsage", fields: [template_id], references: [id])
  historicoPrecos     HistoricoPreco[]
  compras             Compra[]
  comprasTemporarias  CompraTemporaria[]
  stockTeorico        StockTeorico[]
  formatosVendaOrigem FormatoVenda[] @relation("VariacaoOrigem") // NEW: Sell formats using this variation as origin
  itensInventario     ItemInventario[]

  @@map("variacoes_produto")
}

// -----------------------------------------------------------------------------
// PRODUTOS: Purchase Variation Templates
// -----------------------------------------------------------------------------

model TemplateVariacaoCompra {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  
  // Template definition
  nome                String   // "Pack 6un", "Barril 50L", "Saco 25kg"
  descricao           String?  @db.Text
  unidades_por_compra Decimal  @db.Decimal(10, 4)
  unidade_medida      String   // "L", "KG", "Unidade"
  
  // Control
  ativo               Boolean  @default(true)
  ordem_exibicao      Int?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  variacoes           VariacaoProduto[] @relation("TemplateUsage")
  
  @@index([tenant_id, ativo])
  @@index([tenant_id, unidade_medida])
  @@map("template_variacao_compra")
}

// -----------------------------------------------------------------------------
// PRODUTOS: Sell Formats for Products
// -----------------------------------------------------------------------------

// NEW MODEL: Sell Formats for Products
model FormatoVenda {
  id                      Int              @id @default(autoincrement())
  tenant_id               Int
  produto_id              Int
  
  // Identification
  nome                    String           // "Coca-Cola Copo 25cl", "Coca-Cola Lata 33cl"
  descricao               String?          @db.Text
  codigo_interno          String?
  
  // Quantity sold per unit
  quantidade_vendida      Decimal          @db.Decimal(10, 3)
  unidade_medida          String           // "L", "ML", "KG", "G", "UN"
  
  // Pricing (current active price)
  preco_venda             Decimal          @db.Decimal(10, 2)  // PVP (selling price)
  custo_unitario          Decimal          @db.Decimal(10, 2)  // Unit cost (calculated)
  margem_percentual       Decimal          @db.Decimal(5, 2)   // Auto-calculated %
  
  // Source tracking
  variacao_origem_id      Int?             // Origin variation (if direct sale)
  conversao_necessaria    Boolean          @default(false)     // Needs conversion?
  template_id             Int?             // Template used to create this format
  
  // Price validity (for price history)
  data_inicio_vigencia    DateTime         @default(now())
  data_fim_vigencia       DateTime?        // null = currently active
  
  // Control flags
  ativo                   Boolean          @default(true)
  disponivel_menu         Boolean          @default(true)
  ordem_exibicao          Int?
  
  // Timestamps
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  // Relations
  tenant                  Tenant           @relation(fields: [tenant_id], references: [id])
  produto                 Produto          @relation(fields: [produto_id], references: [id])
  variacao_origem         VariacaoProduto? @relation("VariacaoOrigem", fields: [variacao_origem_id], references: [id])
  menu_itens              MenuItem[]
  comboCategoriaOpcoes    ComboCategoriaOpcao[]
  template                TemplateFormatoVenda? @relation("TemplateUsage", fields: [template_id], references: [id])
  
  @@index([tenant_id, produto_id])
  @@index([tenant_id, ativo, disponivel_menu])
  @@index([data_fim_vigencia])
  @@index([template_id])
  @@map("formatos_venda")
}

// -----------------------------------------------------------------------------
// PRODUCTS: Sale Format Templates
// -----------------------------------------------------------------------------

model TemplateFormatoVenda {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  
  // Template definition
  nome                String   // "Copo 25cl", "Lata 33cl", "Garrafa 1L"
  descricao           String?  @db.Text
  quantidade          Decimal  @db.Decimal(10, 3)
  unidade_medida      String   // "L", "ML", "KG", "G", "UN"
  
  // Control
  ativo               Boolean  @default(true)
  ordem_exibicao      Int?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  formatosVenda       FormatoVenda[] @relation("TemplateUsage")
  
  @@index([tenant_id, ativo])
  @@map("template_formato_venda")
}

model HistoricoPreco {
  id                      BigInt   @id @default(autoincrement())
  tenant_id               Int
  variacao_produto_id     Int
  preco_anterior          Decimal  @db.Decimal(10, 2)
  preco_novo              Decimal  @db.Decimal(10, 2)
  preco_unitario_anterior Decimal? @db.Decimal(10, 4)
  preco_unitario_novo     Decimal? @db.Decimal(10, 4)
  percentual_mudanca      Decimal  @db.Decimal(5, 2)
  origem                  String   @default("MANUAL") // MANUAL, COMPRA, SISTEMA
  alterado_por            Int?
  receitas_afetadas       Int      @default(0)
  menus_afetados          Int      @default(0)
  data_mudanca            DateTime @default(now())

  tenant                  Tenant   @relation(fields: [tenant_id], references: [id])
  variacao                VariacaoProduto @relation(fields: [variacao_produto_id], references: [id])
  usuario                 User?    @relation(fields: [alterado_por], references: [id])

  @@map("historico_precos")
}

// -----------------------------------------------------------------------------
// COMPRAS
// -----------------------------------------------------------------------------

model Compra {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  data_compra         DateTime
  variacao_produto_id Int
  quantidade_comprada Decimal  @db.Decimal(10, 4)
  preco_unitario      Decimal  @db.Decimal(10, 4)
  preco_total         Decimal  @db.Decimal(10, 2)
  fornecedor          String?
  numero_fatura       String?
  metodo_entrada      String   // Manual, OCR, API
  documento_url       String?
  validado            Boolean  @default(true)
  data_validacao      DateTime?
  user_id             Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  variacao            VariacaoProduto @relation(fields: [variacao_produto_id], references: [id])
  user                User?    @relation(fields: [user_id], references: [id])

  @@map("compras")
}

model CompraTemporaria {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  sessao_id           String   // Grouping ID for the OCR session
  produto_reconhecido String?
  variacao_id         Int?
  quantidade          Decimal? @db.Decimal(10, 4)
  preco_unitario      Decimal? @db.Decimal(10, 4)
  preco_total         Decimal? @db.Decimal(10, 2)
  fornecedor          String?
  data_compra         DateTime?
  status              String   @default("Pendente") // Pendente, Validado, Corrigido, Rejeitado
  confianca_ocr       Int?     // 0-100
  dados_ocr_raw       Json?
  user_id             Int?
  createdAt           DateTime @default(now())

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  variacao            VariacaoProduto? @relation(fields: [variacao_id], references: [id])
  user                User?    @relation(fields: [user_id], references: [id])

  @@map("compras_temporarias")
}

// -----------------------------------------------------------------------------
// RECEITAS & MENU
// -----------------------------------------------------------------------------

model Receita {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  nome                String
  tipo                String   // Final, Pre-preparo
  numero_porcoes      Decimal  @default(1) @db.Decimal(10, 2)
  tempo_preparacao    Int?     // minutes
  quantidade_total_produzida Decimal? @db.Decimal(10, 4)
  unidade_medida      String?  // KG, L, Unidade
  custo_total         Decimal  @default(0) @db.Decimal(10, 4)
  custo_por_porcao    Decimal  @default(0) @db.Decimal(10, 4)
  imagem_url          String?
  video_url           String?
  descricao           String?  @db.Text
  dificuldade         String?  // Fácil, Média, Difícil
  categoria           String?
  ativa               Boolean  @default(true)
  criado_por          Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  criador             User?    @relation(fields: [criado_por], references: [id])
  ingredientes        IngredienteReceita[] @relation("ReceitaPai")
  ingredienteEm       IngredienteReceita[] @relation("ReceitaFilho")
  etapas              EtapaReceita[]
  menuItems           MenuItem[]
  comboItens          ComboItem[]
  comboCategoriaOpcoes ComboCategoriaOpcao[]

  @@unique([tenant_id, nome])
  @@map("receitas")
}


model IngredienteReceita {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  receita_id          Int
  produto_id          Int?
  receita_preparo_id  Int?
  quantidade_bruta    Decimal  @db.Decimal(10, 4) // Quantidade retirada do armazenamento
  quantidade_liquida  Decimal? @db.Decimal(10, 4) // Quantidade útil após preparação
  rentabilidade       Decimal? @db.Decimal(5, 2)  // (Qtd Líquida / Qtd Bruta) * 100 - calculado
  unidade             String
  custo_ingrediente   Decimal  @default(0) @db.Decimal(10, 4)
  ordem               Int      @default(0)
  notas               String?

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  receita             Receita  @relation("ReceitaPai", fields: [receita_id], references: [id])
  produto             Produto? @relation(fields: [produto_id], references: [id])
  receitaPreparo      Receita? @relation("ReceitaFilho", fields: [receita_preparo_id], references: [id])

  @@map("ingredientes_receita")
}


model EtapaReceita {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  receita_id          Int
  numero_etapa        Int
  descricao           String   @db.Text
  tempo_estimado      Int?     // minutes
  temperatura         Int?     // celsius
  equipamento         String?
  
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  receita             Receita  @relation(fields: [receita_id], references: [id])

  @@unique([receita_id, numero_etapa])
  @@map("etapas_receita")
}

model MenuItem {
  id                  Int              @id @default(autoincrement())
  tenant_id           Int
  uuid                String           @default(uuid())
  receita_id          Int?             // Optional - one of receita_id, combo_id, or formato_venda_id
  combo_id            Int?             // Optional - one of receita_id, combo_id, or formato_venda_id
  formato_venda_id    Int?             // NEW: Sell format (direct product sale)
  nome_comercial      String
  pvp                 Decimal          @db.Decimal(10, 2)
  margem_bruta        Decimal?         @db.Decimal(10, 2)
  margem_percentual   Decimal?         @db.Decimal(5, 2)
  cmv_percentual      Decimal?         @db.Decimal(5, 2)
  categoria_menu      String?          // Entradas, Principais...
  descricao_menu      String?          @db.Text
  alergenos           String?
  calorias            Int?
  tempo_servico       Int?             // minutes
  posicao_menu        Int              @default(0)
  destacado           Boolean          @default(false)
  ativo               Boolean          @default(true)
  imagem_url          String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  tenant              Tenant           @relation(fields: [tenant_id], references: [id])
  receita             Receita?         @relation(fields: [receita_id], references: [id])
  combo               Combo?           @relation(fields: [combo_id], references: [id])
  formatoVenda        FormatoVenda?    @relation(fields: [formato_venda_id], references: [id])
  vendas              Venda[]
  mapeamentosPos      MapeamentoPos[]

  @@map("menu")
}

// -----------------------------------------------------------------------------
// VENDAS
// -----------------------------------------------------------------------------

model Venda {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  data_venda          DateTime
  hora_venda          DateTime? // Can be part of data_venda but kept for explicit separation if needed
  tipo                String   @default("ITEM") // ITEM, TOTAL
  menu_item_id        Int?
  quantidade          Int      @default(1)
  pvp_praticado       Decimal  @db.Decimal(10, 2)
  desconto_percentual Decimal? @db.Decimal(5, 2)
  desconto_valor      Decimal? @db.Decimal(10, 2)
  receita_total       Decimal  @db.Decimal(10, 2)
  custo_total         Decimal? @db.Decimal(10, 2)
  margem_bruta        Decimal? @db.Decimal(10, 2)
  metodo_entrada      String   // Manual, POS, API
  pos_transacao_id    String?
  mesa                String?
  colaborador         String?
  observacoes         String?
  user_id             Int?
  createdAt           DateTime @default(now())

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  menuItem            MenuItem? @relation(fields: [menu_item_id], references: [id])
  user                User?    @relation(fields: [user_id], references: [id])

  @@map("vendas")
}

// -----------------------------------------------------------------------------
// INVENTÁRIO
// -----------------------------------------------------------------------------

model Localizacao {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  nome                String
  descricao           String?
  ativo               Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  itensInventario     ItemInventario[]

  @@unique([tenant_id, nome])
  @@map("localizacoes")
}

model ListaCalculadora {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  nome                String
  descricao           String?
  itens               Json     // Array of { tipo, id, quantidade }
  criado_por          Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  criador             User?    @relation(fields: [criado_por], references: [id])

  @@map("listas_calculadora")
}

model SessaoInventario {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  numero              Int      // Sequential number per tenant
  nome                String?  // Optional name/description
  tipo                String   // "Total", "Calculadora", "Personalizado"
  status              String   // "Aberto", "Fechado", "Cancelado"
  data_inicio         DateTime @default(now())
  data_fim            DateTime?
  filtros_usados      Json?    // Store filters used to generate this session
  criado_por          Int?
  fechado_por         Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  criador             User?    @relation("SessaoCriador", fields: [criado_por], references: [id])
  fechador            User?    @relation("SessaoFechador", fields: [fechado_por], references: [id])
  itens               ItemInventario[]

  @@map("sessoes_inventario")
}

model ItemInventario {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  sessao_id           Int
  produto_id          Int
  variacao_id         Int?     // Optional purchase variation
  localizacao_id      Int?
  quantidade_contada  Decimal  @db.Decimal(10, 4)
  unidade_medida      String
  
  // Snapshot data at time of inventory
  custo_unitario      Decimal? @db.Decimal(10, 4)
  valor_total         Decimal? @db.Decimal(10, 2)
  
  observacoes         String?
  contado_por         Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  sessao              SessaoInventario @relation(fields: [sessao_id], references: [id])
  produto             Produto  @relation(fields: [produto_id], references: [id])
  variacao            VariacaoProduto? @relation(fields: [variacao_id], references: [id])
  localizacao         Localizacao? @relation(fields: [localizacao_id], references: [id])
  contador            User?    @relation(fields: [contado_por], references: [id])

  @@map("itens_inventario")
}

model StockTeorico {
  tenant_id           Int
  produto_id          Int
  variacao_id         Int      @default(0) // 0 if null/base product
  quantidade_atual    Decimal  @db.Decimal(10, 4)
  valor_total         Decimal  @db.Decimal(10, 2)
  data_ultima_atualizacao DateTime @default(now())

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  produto             Produto  @relation(fields: [produto_id], references: [id])
  variacao            VariacaoProduto? @relation(fields: [variacao_id], references: [id])

  @@id([tenant_id, produto_id, variacao_id])
  @@map("stock_teorico")
}

// -----------------------------------------------------------------------------
// AI & INTEGRAÇÕES
// -----------------------------------------------------------------------------

model AlertaAi {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  tipo_alerta         String   // Margem Baixa, Preço Subiu...
  titulo              String
  mensagem            String   @db.Text
  entidade_tipo       String?
  entidade_id         String?
  severidade          String   // Info, Atenção, Crítico
  acoes_sugeridas     Json?
  dados_contexto      Json?
  lido                Boolean  @default(false)
  lido_por            Int?
  data_leitura        DateTime?
  arquivado           Boolean  @default(false)
  expira_em           DateTime?
  createdAt           DateTime @default(now())

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])

  @@map("alertas_ai")
}

model ConversaAi {
  id                  BigInt   @id @default(autoincrement())
  tenant_id           Int
  user_id             Int
  sessao_id           String
  role                String   // user, assistant, system
  mensagem            String   @db.Text
  tokens_usados       Int?
  contexto_adicional  Json?
  timestamp           DateTime @default(now())

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  user                User     @relation(fields: [user_id], references: [id])

  @@map("conversas_ai")
}

model Integracao {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  tipo_integracao     String   // POS, Contabilidade, Email
  nome                String
  provedor            String   // Lightspeed, Square...
  ativa               Boolean  @default(true)
  configuracao        Json?
  ultimo_sync         DateTime?
  status_ultimo_sync  String?
  mensagem_erro       String?
  criado_por          Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  criador             User?    @relation(fields: [criado_por], references: [id])
  mapeamentosPos      MapeamentoPos[]

  @@map("integracoes")
}

model MapeamentoPos {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  integracao_id       Int
  pos_item_id         String
  pos_item_nome       String
  menu_item_id        Int
  ativo               Boolean  @default(true)

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  integracao          Integracao @relation(fields: [integracao_id], references: [id])
  menuItem            MenuItem @relation(fields: [menu_item_id], references: [id])

  @@unique([tenant_id, integracao_id, pos_item_id])
  @@map("mapeamento_pos")
}

// -----------------------------------------------------------------------------
// COMBOS - Combinações de Receitas e Produtos
// -----------------------------------------------------------------------------

model Combo {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  nome                String
  tipo                String   @default("Simples") // "Simples" | "Complexo"
  descricao           String?  @db.Text
  imagem_url          String?
  custo_total         Decimal  @default(0) @db.Decimal(10, 4)
  ativo               Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  itens               ComboItem[]      // For "Complexo" type
  categorias          ComboCategoria[] // For "Simples" type
  menuItems           MenuItem[]

  @@unique([tenant_id, nome])
  @@map("combos")
}

model ComboItem {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  combo_id            Int
  receita_id          Int?     // Pode ser uma receita final
  produto_id          Int?     // Ou um produto (ex: bebida individual)
  quantidade          Decimal  @db.Decimal(10, 4)
  custo_unitario      Decimal  @db.Decimal(10, 4)
  custo_total         Decimal  @db.Decimal(10, 4) // quantidade * custo_unitario
  ordem               Int      @default(0)
  observacoes         String?

  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  combo               Combo    @relation(fields: [combo_id], references: [id], onDelete: Cascade)
  receita             Receita? @relation(fields: [receita_id], references: [id])
  produto             Produto? @relation(fields: [produto_id], references: [id])

  @@map("combo_itens")
}

model ComboCategoria {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  combo_id            Int
  categoria           String   // "Sopa", "Prato Principal", "Sobremesa", "Bebida", "Café"
  ordem               Int      @default(0)
  obrigatoria         Boolean  @default(true)
  custo_max_calculado Decimal  @default(0) @db.Decimal(10, 4)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  combo               Combo    @relation(fields: [combo_id], references: [id], onDelete: Cascade)
  opcoes              ComboCategoriaOpcao[]
  
  @@unique([combo_id, categoria])
  @@map("combo_categorias")
}

model ComboCategoriaOpcao {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  categoria_id        Int
  receita_id          Int?     // Opção de receita
  formato_venda_id    Int?     // Opção de formato de venda (bebida)
  custo_unitario      Decimal  @db.Decimal(10, 4)
  ordem               Int      @default(0)
  
  createdAt           DateTime @default(now())
  
  tenant              Tenant           @relation(fields: [tenant_id], references: [id])
  categoria           ComboCategoria   @relation(fields: [categoria_id], references: [id], onDelete: Cascade)
  receita             Receita?         @relation(fields: [receita_id], references: [id])
  formatoVenda        FormatoVenda?    @relation(fields: [formato_venda_id], references: [id])
  
  @@map("combo_categoria_opcoes")
}

// -----------------------------------------------------------------------------
// DADOS DO RESTAURANTE - Operational Settings & Structural Costs
// -----------------------------------------------------------------------------

model DadosRestaurante {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int      @unique
  
  // Operational Settings
  numero_lugares      Int      @default(0)
  horas_trabalho_dia  Decimal  @default(8) @db.Decimal(4, 2)
  dias_trabalho_semana Decimal @default(5) @db.Decimal(3, 1)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])

  // Alert Thresholds
  cmv_alerta_amarelo          Decimal  @default(30) @db.Decimal(5, 2)
  cmv_alerta_vermelho         Decimal  @default(35) @db.Decimal(5, 2)
  alerta_aumento_custo_leve   Decimal  @default(5) @db.Decimal(5, 2)
  alerta_aumento_custo_medio  Decimal  @default(10) @db.Decimal(5, 2)
  alerta_aumento_custo_grave  Decimal  @default(15) @db.Decimal(5, 2)
  alerta_inatividade_leve     Int      @default(3)
  alerta_inatividade_medio    Int      @default(6)
  alerta_inatividade_grave    Int      @default(10)
  
  @@map("dados_restaurante")
}

model CustoEstrutura {
  id                  Int      @id @default(autoincrement())
  tenant_id           Int
  uuid                String   @default(uuid())
  
  descricao           String
  classificacao       String   // Salário, Eletricidade, Água, Marketing, Contabilidade, Sistemas, Internet, Veículos, Renda, Gestão, Outros
  valor_mensal        Decimal  @db.Decimal(10, 2)
  
  ativo               Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  tenant              Tenant   @relation(fields: [tenant_id], references: [id])
  
  @@index([tenant_id, ativo])
  @@map("custos_estrutura")
}

